<div class="orders-page">
  <h2>üì¶ Objedn√°vky</h2>

  <div class="page-header">
    <div class="back-buttons">
      <button class="back-one-btn" (click)="goBackOneStep()">‚¨Ö O krok zpƒõt</button>
      <button class="back-btn" (click)="goBack()">‚¨Ö Zpƒõt na Dashboard</button>
    </div>

    <div class="new-order" *ngIf="isAdmin()">
      <button class="add-btn" (click)="startNew()">‚ûï P≈ôidat objedn√°vku</button>
    </div>
  </div>

  <div *ngIf="newOrder" class="form-box">
    <div class="inner-form">
      <select [(ngModel)]="newOrder.customer" [compareWith]="compareCustomer">
        <option [ngValue]="null">-- Vyber z√°kazn√≠ka --</option>
        <option *ngFor="let cust of customers" [ngValue]="cust">
          {{ cust.name }}
        </option>
      </select>

      <input type="date" [(ngModel)]="newOrder.date" [min]="today" />

      <div class="order-items">
        <div class="order-item" *ngFor="let item of newOrder.items; let i = index">
          <select [(ngModel)]="item.category" [compareWith]="compareCategory">
            <option [ngValue]="undefined">-- Vyber kategorii --</option>
            <option *ngFor="let cat of categories" [ngValue]="cat">
              {{ cat.name }}
            </option>
          </select>

          <select [(ngModel)]="item.product" [compareWith]="compareProduct">
            <option [ngValue]="null">-- Vyber produkt --</option>
            <option *ngFor="let prod of getFilteredProducts(item.category?.id)" [ngValue]="prod">
              {{ prod.name }}
            </option>
          </select>

          <input type="number" [(ngModel)]="item.quantity" placeholder="Mno≈æstv√≠" min="1" />

          <span class="price">
            {{ item.product ? item.product.price * (item.quantity || 0) : 0 }} Kƒç
          </span>

          <div class="item-actions">
            <button type="button" class="add-btn" (click)="addItem()">‚ûï P≈ôidat</button>
            <button type="button" class="delete-btn" (click)="removeItem(i)">üóëÔ∏è Smazat</button>
          </div>
        </div>
      </div>

      <div class="order-total">Celkem: {{ totalPrice }} Kƒç</div>

      <button class="save-btn" (click)="saveNew()">üíæ Ulo≈æit</button>
      <button class="cancel-btn" (click)="cancelNew()">‚úñ Zru≈°it</button>
    </div>
  </div>

  <table class="orders-table" *ngIf="orders.length > 0">
    <thead>
      <tr>
        <th class="id-col" (click)="sortData('id')">
          ID <span *ngIf="sortColumn === 'id'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
        </th>
        <th class="customer-col" (click)="sortData('customer')">
          Z√°kazn√≠k <span *ngIf="sortColumn === 'customer'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
        </th>
        <th class="date-col" (click)="sortData('date')">
          Datum <span *ngIf="sortColumn === 'date'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
        </th>
        <th class="price-col" (click)="sortData('price')">
          Cena celkem <span *ngIf="sortColumn === 'price'">{{ sortDirection === 'asc' ? '‚Üë' : '‚Üì' }}</span>
        </th>
        <th class="actions-col" *ngIf="isAdmin()">Akce</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let order of pagedOrders" [ngClass]="{ editing: editingOrder?.id === order.id }">
        <ng-container *ngIf="editingOrder?.id === order.id; else viewMode">
          <td [attr.colspan]="isAdmin() ? 5 : 4">
            <div class="form-box">
              <div class="inner-form">
                <select [(ngModel)]="editingOrder!.customer" [compareWith]="compareCustomer">
                  <option [ngValue]="null">-- Vyber z√°kazn√≠ka --</option>
                  <option *ngFor="let cust of customers" [ngValue]="cust">
                    {{ cust.name }}
                  </option>
                </select>

                <input type="date" [(ngModel)]="editingOrder!.date" [min]="today" />

                <div class="order-items">
                  <div class="order-item" *ngFor="let item of editingOrder!.items; let i = index">
                    <select [(ngModel)]="item.category" [compareWith]="compareCategory">
                      <option [ngValue]="undefined">-- Vyber kategorii --</option>
                      <option *ngFor="let cat of categories" [ngValue]="cat">
                        {{ cat.name }}
                      </option>
                    </select>

                    <select [(ngModel)]="item.product" [compareWith]="compareProduct">
                      <option [ngValue]="null">-- Vyber produkt --</option>
                      <option *ngFor="let prod of getFilteredProducts(item.category?.id)" [ngValue]="prod">
                        {{ prod.name }}
                      </option>
                    </select>

                    <input type="number" [(ngModel)]="item.quantity" placeholder="Mno≈æstv√≠" min="1" />

                    <span class="price">
                      {{ item.product ? item.product.price * (item.quantity || 0) : 0 }} Kƒç
                    </span>

                    <div class="item-actions">
                      <button type="button" class="add-btn" (click)="addItem()">‚ûï P≈ôidat</button>
                      <button type="button" class="delete-btn" (click)="removeItem(i)">üóëÔ∏è Smazat</button>
                    </div>
                  </div>
                </div>

                <div class="order-total">Celkem: {{ getEditingOrderTotal() }} Kƒç</div>

                <button class="save-btn" (click)="saveEdit()">üíæ Ulo≈æit</button>
                <button class="cancel-btn" (click)="cancelEdit()">‚úñ Zru≈°it</button>
              </div>
            </div>
          </td>
        </ng-container>

        <ng-template #viewMode>
          <td class="id-col">{{ order.id }}</td>
          <td class="customer-col">{{ order.customer.name }}</td>
          <td class="date-col">{{ order.date | date: "yyyy-MM-dd" }}</td>
          <td class="price-col">{{ getOrderTotal(order) }} Kƒç</td>
          <td class="actions-col" *ngIf="isAdmin()">
            <button class="edit-btn" (click)="startEdit(order)">‚úè Upravit</button>
            <button class="delete-btn" (click)="deleteOrder(order.id)">üóë Smazat</button>
          </td>
        </ng-template>
      </tr>
    </tbody>
  </table>

  <div class="pagination" *ngIf="orders.length > 0">
    <button (click)="changePage(currentPage - 1)" [disabled]="currentPage === 1">‚¨Ö P≈ôedchoz√≠</button>
    <span>Str√°nka {{ currentPage }} z {{ totalPages }}</span>
    <button (click)="changePage(currentPage + 1)" [disabled]="currentPage === totalPages">Dal≈°√≠ ‚û°</button>
    <label>
      Z√°znam≈Ø na str√°nku:
      <select [(ngModel)]="pageSize" (ngModelChange)="changePageSize($event)">
        <option *ngFor="let size of pageSizes" [ngValue]="size">{{ size }}</option>
      </select>
    </label>
  </div>

  <p *ngIf="orders.length === 0 && !loading">≈Ω√°dn√© objedn√°vky nebyly nalezeny.</p>
</div>
