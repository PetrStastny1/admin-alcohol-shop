<div class="orders-page">
  <h2>üì¶ Objedn√°vky</h2>

  <button class="back-btn" (click)="goBack()">‚¨Ö Zpƒõt na Dashboard</button>

  <div class="new-order" *ngIf="isAdmin()">
    <button class="add-btn" (click)="startNew()">‚ûï P≈ôidat objedn√°vku</button>
  </div>

  <div *ngIf="newOrder" class="form-box">
    <div class="inner-form">
      <select [(ngModel)]="newOrder.customer" [compareWith]="compareCustomer">
        <option [ngValue]="undefined">-- Vyber z√°kazn√≠ka --</option>
        <option *ngFor="let cust of customers" [ngValue]="cust">{{ cust.name }}</option>
      </select>

      <select [(ngModel)]="newOrder.category" [compareWith]="compareCategory">
        <option [ngValue]="undefined">-- Vyber kategorii --</option>
        <option *ngFor="let cat of categories" [ngValue]="cat">{{ cat.name }}</option>
      </select>

      <select [(ngModel)]="newOrder.product" [compareWith]="compareProduct">
        <option [ngValue]="undefined">-- Vyber produkt --</option>
        <option *ngFor="let prod of products" [ngValue]="prod">{{ prod.name }}</option>
      </select>

      <input type="number" [(ngModel)]="newOrder.quantity" placeholder="Mno≈æstv√≠" />
      <input type="date" [(ngModel)]="newOrder.date" [min]="today" />

      <input
        [value]="(newOrder.product?.price ?? 0) * (newOrder.quantity || 0)"
        placeholder="Cena celkem"
        readonly
      />

      <button class="save-btn" (click)="saveNew()">üíæ Ulo≈æit</button>
      <button class="cancel-btn" (click)="cancelNew()">‚úñ Zru≈°it</button>
    </div>
  </div>

  <table class="orders-table" *ngIf="orders.length > 0">
    <thead>
      <tr>
        <th class="id-col">ID</th>
        <th class="customer-col">Z√°kazn√≠k</th>
        <th class="category-col">Kategorie</th>
        <th class="product-col">Produkt</th>
        <th class="qty-col">Mno≈æstv√≠</th>
        <th class="date-col">Datum</th>
        <th class="price-col">Cena celkem</th>
        <th class="actions-col" *ngIf="isAdmin()">Akce</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let order of orders" [ngClass]="{ editing: editingOrder?.id === order.id }">
        <ng-container *ngIf="editingOrder?.id === order.id; else viewMode">
          <td colspan="8">
            <div class="form-box">
              <div class="inner-form">
                <select [(ngModel)]="editingOrder!.customer" [compareWith]="compareCustomer">
                  <option [ngValue]="undefined">-- Vyber z√°kazn√≠ka --</option>
                  <option *ngFor="let cust of customers" [ngValue]="cust">{{ cust.name }}</option>
                </select>

                <select [(ngModel)]="editingOrder!.category" [compareWith]="compareCategory">
                  <option [ngValue]="undefined">-- Vyber kategorii --</option>
                  <option *ngFor="let cat of categories" [ngValue]="cat">{{ cat.name }}</option>
                </select>

                <select [(ngModel)]="editingOrder!.product" [compareWith]="compareProduct">
                  <option [ngValue]="undefined">-- Vyber produkt --</option>
                  <option *ngFor="let prod of products" [ngValue]="prod">{{ prod.name }}</option>
                </select>

                <input type="number" [(ngModel)]="editingOrder!.quantity" placeholder="Mno≈æstv√≠" />
                <input type="date" [(ngModel)]="editingOrder!.date" [min]="today" />

                <input
                  [value]="(editingOrder!.product?.price ?? 0) * editingOrder!.quantity"
                  placeholder="Cena celkem"
                  readonly
                />

                <button class="save-btn" (click)="saveEdit()">üíæ Ulo≈æit</button>
                <button class="cancel-btn" (click)="cancelEdit()">‚úñ Zru≈°it</button>
              </div>
            </div>
          </td>
        </ng-container>
        <ng-template #viewMode>
          <td class="id-col">{{ order.id }}</td>
          <td class="customer-col">{{ order.customer.name }}</td>
          <td class="category-col">{{ order.category?.name || '-' }}</td>
          <td class="product-col">{{ order.product?.name || '-' }}</td>
          <td class="qty-col">{{ order.quantity }}</td>
          <td class="date-col">{{ order.date | date: 'yyyy-MM-dd' }}</td>
          <td class="price-col">{{ order.totalPrice }} Kƒç</td>
          <td class="actions-col" *ngIf="isAdmin()">
            <button class="edit-btn" (click)="startEdit(order)">‚úè Upravit</button>
            <button class="delete-btn" (click)="deleteOrder(order.id)">üóë Smazat</button>
          </td>
        </ng-template>
      </tr>
    </tbody>
  </table>

  <p *ngIf="orders.length === 0 && !loading">≈Ω√°dn√© objedn√°vky nebyly nalezeny.</p>
</div>
