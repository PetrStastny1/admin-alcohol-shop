<div class="orders-page">
  <h2>ğŸ“¦ ObjednÃ¡vky</h2>

  <div class="back-buttons">
    <button class="back-one-btn" (click)="goBackOneStep()">â¬… O krok zpÄ›t</button>
    <button class="back-btn" (click)="goBack()">â¬… ZpÄ›t na Dashboard</button>
  </div>

  <div class="new-order" *ngIf="isAdmin()">
    <button class="add-btn" (click)="startNew()">â• PÅ™idat objednÃ¡vku</button>
  </div>

  <div *ngIf="newOrder" class="form-box">
    <div class="inner-form">
      <select [(ngModel)]="newOrder.customer" [compareWith]="compareCustomer">
        <option [ngValue]="null">-- Vyber zÃ¡kaznÃ­ka --</option>
        <option *ngFor="let cust of customers" [ngValue]="cust">
          {{ cust.name }}
        </option>
      </select>

      <input type="date" [(ngModel)]="newOrder.date" [min]="today" />

      <div class="order-items">
        <div class="order-item" *ngFor="let item of newOrder.items; let i = index">
          <select [(ngModel)]="item.category" [compareWith]="compareCategory">
            <option [ngValue]="undefined">-- Vyber kategorii --</option>
            <option *ngFor="let cat of categories" [ngValue]="cat">
              {{ cat.name }}
            </option>
          </select>

          <select [(ngModel)]="item.product" [compareWith]="compareProduct">
            <option [ngValue]="null">-- Vyber produkt --</option>
            <option *ngFor="let prod of getFilteredProducts(item.category?.id)" [ngValue]="prod">
              {{ prod.name }}
            </option>
          </select>

          <input type="number" [(ngModel)]="item.quantity" placeholder="MnoÅ¾stvÃ­" min="1" />

          <span class="price">
            {{ item.product ? item.product.price * (item.quantity || 0) : 0 }} KÄ
          </span>

          <div class="item-actions">
            <button type="button" class="add-btn" (click)="addItem()">â• PÅ™idat</button>
            <button type="button" class="delete-btn" (click)="removeItem(i)">ğŸ—‘ï¸ Smazat</button>
          </div>
        </div>
      </div>

      <div class="order-total">Celkem: {{ totalPrice }} KÄ</div>

      <button class="save-btn" (click)="saveNew()">ğŸ’¾ UloÅ¾it</button>
      <button class="cancel-btn" (click)="cancelNew()">âœ– ZruÅ¡it</button>
    </div>
  </div>

  <table class="orders-table" *ngIf="orders.length > 0">
    <thead>
      <tr>
        <th class="id-col" (click)="sortData('id')">
          ID <span *ngIf="sortColumn === 'id'">{{ sortDirection === 'asc' ? 'â†‘' : 'â†“' }}</span>
        </th>
        <th class="customer-col" (click)="sortData('customer')">
          ZÃ¡kaznÃ­k <span *ngIf="sortColumn === 'customer'">{{ sortDirection === 'asc' ? 'â†‘' : 'â†“' }}</span>
        </th>
        <th class="date-col" (click)="sortData('date')">
          Datum <span *ngIf="sortColumn === 'date'">{{ sortDirection === 'asc' ? 'â†‘' : 'â†“' }}</span>
        </th>
        <th class="price-col" (click)="sortData('price')">
          Cena celkem <span *ngIf="sortColumn === 'price'">{{ sortDirection === 'asc' ? 'â†‘' : 'â†“' }}</span>
        </th>
        <th class="actions-col" *ngIf="isAdmin()">Akce</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let order of pagedOrders" [ngClass]="{ editing: editingOrder?.id === order.id }">
        <ng-container *ngIf="editingOrder?.id === order.id; else viewMode">
          <td colspan="5">
            <div class="form-box">
              <div class="inner-form">
                <select [(ngModel)]="editingOrder!.customer" [compareWith]="compareCustomer">
                  <option [ngValue]="null">-- Vyber zÃ¡kaznÃ­ka --</option>
                  <option *ngFor="let cust of customers" [ngValue]="cust">
                    {{ cust.name }}
                  </option>
                </select>

                <input type="date" [(ngModel)]="editingOrder!.date" [min]="today" />

                <div class="order-items">
                  <div class="order-item" *ngFor="let item of editingOrder!.items; let i = index">
                    <select [(ngModel)]="item.category" [compareWith]="compareCategory">
                      <option [ngValue]="undefined">-- Vyber kategorii --</option>
                      <option *ngFor="let cat of categories" [ngValue]="cat">
                        {{ cat.name }}
                      </option>
                    </select>

                    <select [(ngModel)]="item.product" [compareWith]="compareProduct">
                      <option [ngValue]="null">-- Vyber produkt --</option>
                      <option *ngFor="let prod of getFilteredProducts(item.category?.id)" [ngValue]="prod">
                        {{ prod.name }}
                      </option>
                    </select>

                    <input type="number" [(ngModel)]="item.quantity" placeholder="MnoÅ¾stvÃ­" min="1" />

                    <span class="price">
                      {{ item.product ? item.product.price * (item.quantity || 0) : 0 }} KÄ
                    </span>

                    <div class="item-actions">
                      <button type="button" class="add-btn" (click)="addItem()">â• PÅ™idat</button>
                      <button type="button" class="delete-btn" (click)="removeItem(i)">ğŸ—‘ï¸ Smazat</button>
                    </div>
                  </div>
                </div>

                <div class="order-total">Celkem: {{ getEditingOrderTotal() }} KÄ</div>

                <button class="save-btn" (click)="saveEdit()">ğŸ’¾ UloÅ¾it</button>
                <button class="cancel-btn" (click)="cancelEdit()">âœ– ZruÅ¡it</button>
              </div>
            </div>
          </td>
        </ng-container>

        <ng-template #viewMode>
          <td class="id-col">{{ order.id }}</td>
          <td class="customer-col">{{ order.customer.name }}</td>
          <td class="date-col">{{ order.date | date: "yyyy-MM-dd" }}</td>
          <td class="price-col">{{ getOrderTotal(order) }} KÄ</td>
          <td class="actions-col" *ngIf="isAdmin()">
            <button class="edit-btn" (click)="startEdit(order)">âœ Upravit</button>
            <button class="delete-btn" (click)="deleteOrder(order.id)">ğŸ—‘ Smazat</button>
          </td>
        </ng-template>
      </tr>
    </tbody>
  </table>

  <div class="pagination" *ngIf="orders.length > 0">
    <button (click)="changePage(currentPage - 1)" [disabled]="currentPage === 1">â¬… PÅ™edchozÃ­</button>
    <span>StrÃ¡nka {{ currentPage }} z {{ totalPages }}</span>
    <button (click)="changePage(currentPage + 1)" [disabled]="currentPage === totalPages">DalÅ¡Ã­ â¡</button>
    <label>
      ZÃ¡znamÅ¯ na strÃ¡nku:
      <select [(ngModel)]="pageSize" (ngModelChange)="changePageSize($event)">
        <option *ngFor="let size of pageSizes" [ngValue]="size">{{ size }}</option>
      </select>
    </label>
  </div>

  <p *ngIf="orders.length === 0 && !loading">Å½Ã¡dnÃ© objednÃ¡vky nebyly nalezeny.</p>
</div>
